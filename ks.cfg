# Generated by Anaconda 34.25.1.14
# Generated by pykickstart v3.32
#version=RHEL9

# Use none-intractive install // changed from grafical
text --non-interactive

url --url=https://ftp.fau.de/almalinux/9.4/BaseOS/x86_64/os/

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8


# Network information
network --activate
# install server invorment with now extras
%packages
@^server-product-environment

%end

# Run the Setup Agent on first boot
firstboot --enable

# System timezone
timezone Europe/Berlin --utc
# timesource --ntp-server ntp0.fau.de

# Root password
rootpw --iscrypted $6$PCiXDz.zRD1mUnSC$U7alSAYJK.vGl/e46T4DFYNy/kfRJ9IfxV3dbhetjKkTU25Ax3fGRoiSMQaJ9Ht8jxVvt0OQDO4IVAFFlpaYd0

# acsept license
eula --agreed

reboot

%pre
#!/bin/bash
selected_disk=""
# iterate over disks by chatGPT
for disk in $(lsblk -n -b -o SIZE,NAME | awk '$1 >= 3000*1024*1024*1024 && $1 <= 5000*1024*1024*1024 {print $2}'); do
  if [[ -z "$selected_disk" ]]; then
    selected_disk=$disk
  fi
done

# anaconda dose not support bash in sections so commands hafe to be written to a file with will be in cluded
echo "bootloader --boot-drive=$selected_disk" >> /tmp/disk_selection.ks
echo "clearpart --all --disklabel gpt --drives=$selected_disk" > /tmp/disk_selection.ks
echo "part /boot/efi --fstype efi --size 1024 --ondrive=$selected_disk" >> /tmp/disk_selection.ks
echo "part / --asprimary --size=200 --grow --fsoptions="defaults" --label=root --fstype=xfs --ondrive=$selected_disk" >> /tmp/disk_selection.ks

%end

%include /tmp/disk_selection.ks

%post
# setting the ntp server with the kickstart did not work
echo "server ntp0.fau.de" >> /etc/ntp.conf
systemctl enable --now ntpd
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCmzT+1OY2hN48FkSj9XvZd+VtjlG4Z4orICSzp0htYIYKxYM9+xLfh9joSrRiLfywBO+rAsfYpjicjSyspAVsbTHdHv+xlmiwKrjp4qz1owCjqPWoiwhIE9dMTYCJT8ZY6LDLq8y90AwPMFGHeCVX1VY/yO6No0kwR6YuYmsbDi4WAiBAQ0UvlfyACcrhnyUh84bY4Z5halpoGVe+MGEAjjL9zSfEuoOnRyz9E+LS9y4Nwa5zq+il/W/ixE5eHZONzV4jHlMqUCUr8mleO1CIsUisMmba2a5392euQ121u0t7Ab5s5UL3ogWKOnu/kKKMmmST2CdpDtWMH/QcilYV4aq5rdh11XGcXCQ1G/Udr7mwXP/2syQ3ysNmHjkgQvJyT8Xhi/Uari+05FfV79q82ojFbn83fqpQG1IZr7+5tzwyDFZP62cQekmpI0LNWWJBSTlslxLHEGEEzKPB9wFLx4j9Rl/sUntrPdK6MdnvWylpXFZ8mw0+vQo0SusDuUB8= user@fau" >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
%end


